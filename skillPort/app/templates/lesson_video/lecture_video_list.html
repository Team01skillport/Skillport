{% extends "base.html" %} {% block title %}{{cat_name}}{% endblock %} {% block
content %}
<head>
  <link
    rel="stylesheet"
    href="{{url_for('static', filename='css/lecture_video.css')}}"
  />
</head>
<body>
  <div class="category-page">
    <div class="category-header">
      <h1>{{cat_name}}</h1>
      <button class="upload-video-btn">動画をアップロード</button>
    </div>

    <div>
      <ul class="item-grid">
        {% for video in category_videos %}
        <a
          href="{{ url_for('lesson_video.video_player', video_id = video.video_id)}}"
        >
          <li class="item-card">
            <div class="item-image-container">
              <img
                src="{{ url_for('static', filename='media' + video.thumbnail_path)}}"
                alt="画像ここ"
                class="item-image"
              />
              <p class="image-label">動画コース</p>
            </div>
            <p class="item-title">{{ video.video_title }}</p>
            <p class="item-description">
              {{ video.video_description_section }}
            </p>
            <div class="video_stats">
              <p class="video_upload_date">
                {{ video.video_upload_date.date() }}
              </p>
              <p>{{ video.user_name }}</p>
            </div>
          </li>
        </a>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div id="uploadModal" class="modal">
    <div class="modal__backdrop"></div>
    <div class="modal__card">
      <button class="modal__close" aria-label="Close modal">×</button>
      <div class="modal__content">
        <form
          id="uploadForm"
          enctype="multipart/form-data"
          method="POST"
          action="{{url_for('lesson_video.video_upload')}}"
        >
          <div class="upload-fields">
            <div class="file-preview-group">
              <div class="file-button-container">
                <label class="file-label file-button thumbnail-button">
                  ファイルを選択
                  <input
                    type="file"
                    id="videoFile"
                    name="video_file"
                    accept="video/mp4,video/quicktime"
                  />
                </label>

                <label class="file-label file-button thumbnail-button">
                  サムイルを選択
                  <input
                    type="file"
                    id="thumbnailFile"
                    name="thumbnail_file"
                    accept="image/*"
                  />
                </label>

                <span id="fileName" class="file-name-display"></span>
              </div>

              <div class="thumbnail-image-preview">
                <img src="../static/media/default_thumbnail.jpg" alt="" />
              </div>
            </div>

            <label for="videoTitle" class="form-label">タイトル</label>
            <input
              type="text"
              id="videoTitle"
              name="video_title"
              class="form-input"
              placeholder=""
            />

            <label for="videoDescription" class="form-label">概要欄</label>
            <textarea
              id="videoDescription"
              name="video_description"
              class="form-textarea"
            ></textarea>
            <br />

            <label for="upload_category_select" class="form-label"
              >カテゴリー</label
            >
            <select name="upload_category" id="upload_category_select">
              <option value="アニメーション">アニメーション</option>
              <option value="音楽">音楽</option>
              <option value="カメラ">カメラ</option>
              <option value="フィットネス">フィットネス</option>
              <option value="英語">英語</option>
              <option value="プログラミング">プログラミング</option>
            </select>
            <div class="modal__actions">
              <button class="btn btn--primary">アップロード</button>
              <!-- <div class="member-setting">
                <span>メンバー限定</span>
                <span class="dot">•</span>
              </div> -->
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    // JavaScript 簡單控制邏輯 (處理 Modal 打開與關閉)

    const uploadBtn = document.querySelector(".upload-video-btn");
    const modal = document.getElementById("uploadModal");
    // 由於 Modal 結構已恢復，這裡的查找會成功
    const closeBtn = modal ? modal.querySelector(".modal__close") : null;
    const backdrop = modal ? modal.querySelector(".modal__backdrop") : null;
    const videoFileInput = document.getElementById("videoFile");
    const fileNameDisplay = modal
      ? modal.querySelector(".file-name-display")
      : null;

    function openModal() {
      if (modal) {
        modal.classList.add("is-open");
        document.body.classList.add("modal-open");
      }
    }

    function closeModal() {
      if (modal) {
        modal.classList.remove("is-open");
        document.body.classList.remove("modal-open");
      }
    }

    if (uploadBtn) uploadBtn.addEventListener("click", openModal);
    if (closeBtn) closeBtn.addEventListener("click", closeModal);
    if (backdrop) backdrop.addEventListener("click", closeModal);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal && modal.classList.contains("is-open")) {
        closeModal();
      }
    });

    // 更新檔案名稱顯示
    if (videoFileInput && fileNameDisplay) {
      videoFileInput.addEventListener("change", () => {
        if (videoFileInput.files.length > 0) {
          fileNameDisplay.textContent = videoFileInput.files[0].name;
        } else {
          fileNameDisplay.textContent = "animation.mp4";
        }
      });
    }

    document
      .getElementById("thumbnailFile")
      .addEventListener("change", function () {
        const img = document.querySelector(".thumbnail-image-preview img");
        const file = this.files[0];

        if (file) {
          img.src = URL.createObjectURL(file);
        }
      });
  </script>
</body>
{% endblock %}
