{% extends "base.html" %} 
{% block title %}{{ info.product_name |
default('商品詳細', true) }}{% endblock %} 

{% block styles %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/product_detail.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/popup_report.css') }}"
/>
<style>
  /* 評価表示のスタイルは product_detail.css に移動しました */
  .dummy-main-image {
    width: 100%;
    height: var(--main-img, 440px);
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f8f8;
    border: 1.5px solid #ccc;
    border-radius: 10px;
    font-size: 1.5rem;
    color: #aaa;
    flex-direction: column;
  }
  
  /* [新增] 评论表单のスタイル */
  .comment-form {
    margin-bottom: 20px;
  }
  .comment-form textarea {
    width: 100%;
    min-height: 80px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    font-size: 14px;
    margin-bottom: 10px;
  }
  .comment-form .comment-btn {
    width: 100%;
  }
  
  /* [新增] 评论列表のスタイル */
  .comment-box li p {
    margin: 0;
  }
  .comment-box li strong {
    font-size: 13px;
  }
</style>
{% endblock %} 

{% block content %}
<div class="page-wrap">
  <main class="product-section">
    <div class="image-area">
      <div class="thumbnails">
        
        {% if info.image_path %}
        <img
          src="{{ url_for('static', filename=info.image_path) }}"
          class="thumb active"
          alt="サムネイル1"
        />
        {% endif %} 
        {% for img in other_images %}
        <img
          src="{{ url_for('static', filename=img.image_path) }}"
          class="thumb"
          alt="サムネイル{{ loop.index + 1 }}"
        />
        {% endfor %}
        </div>
      {# ⭐ メイン画像エリアの変更 ⭐ #}
      <div class="main-image {% if info.sales_status == 'C' %}sold-out{% endif %}">
        
        {% if info.image_path %}
        <img
          id="mainImage"
          src="{{ url_for('static', filename=info.image_path) }}"
          alt="メイン商品画像"
        />
        {% else %}
        <div class="dummy-main-image">
          <span>?</span>
          <p style="font-size: 1rem; margin-top: 10px">画像がありません</p>
        </div>
        {% endif %}

        {% if info.sales_status == 'C' %}
        <div class="sold-out-overlay">SOLD OUT</div>
        {% endif %}
      </div>
    </div>
    <div class="info-area">
      <h1>{{info.product_name}}</h1>
      <p class="price">¥{{info.product_price}}(税込)</p>

      <div class="action-buttons">
        <input type="button" value="♡ お気に入り"  id="favorite_button" data-product-id="{{info.product_id}}" class="btn {% if info.sales_status == 'C' %}sold-out-button{% endif %}" {% if info.sales_status == 'C' %}disabled{% endif %} {% if info.like_status %}style="background-color:#007bff; color:white; font-weight: bold;"{%endif%}>
        <a href="#" class="btn" id="reportBtn">通報</a>
      </div>

      {# ⭐ 購入ボタンの変更 ⭐ #}
      <a
        href="{% if info.sales_status == 'C' %}#{% else %}{{ url_for('market.checkout_page', product_id=info.product_id) }}{% endif %}"
        class="buy-btn {% if info.sales_status == 'C' %}sold-out-button{% endif %}"
        {% if info.sales_status == 'C' %}onclick="return false;"{% endif %}
      >
        {% if info.sales_status == 'C' %}SOLD OUT{% else %}購入{% endif %}
      </a>

      <div class="desc">
        <h2>商品の説明</h2>
        <p>{{info.product_description}}</p>
      </div>

      <div class="detail">
        <h2>商品の情報</h2>
        <ul>
          <li>商品の状態：<b>{{info.product_condition}}</b></li>
          <li>配送元の地域：<b>{{info.shipping_area}}</b></li>
        </ul>
      </div>
    </div>
  </main>

  <section class="bottom-section">
    <div class="comment-box">
      
      <div class="comment-form" data-product-id="{{ info.product_id }}">
        <h3>コメント投稿</h3>
        <textarea id="commentInput" placeholder="商品についての質問やコメントを入力..." rows="4"></textarea>
        <button id="commentSubmitBtn" class="comment-btn">コメント投稿</button>
      </div>

      <h3>コメント一覧</h3>
      
      <ul id="commentList">
        {% if comments %}
          {% for comment in comments %}
          <li>
            
            {% if comment.profile_icon and comment.profile_icon != '/icons/default_icon.png' %}
              <img src="{{ url_for('static', filename=comment.profile_icon) }}" alt="icon">
            {% else %}
              <img src="{{ url_for('static', filename='media/profile_icon.png') }}" alt="icon">
            {% endif %}
            <div class="bubble">
              <strong>{{ comment.user_name }}</strong>
              <p>{{ comment.comment_text }}</p>
            </div>
          </li>
          {% endfor %}
        {% else %}
          <li id="noCommentsYet">まだコメントがありません。</li>
        {% endif %}
      </ul>
    </div>
    
    <div class="seller-box">
      <h3>出品者</h3>
      <div class="seller-info">
        
        {% if info.seller_icon and info.seller_icon != '/icons/default_icon.png' %}
        <img
          src="{{ url_for('static', filename=info.seller_icon) }}"
          alt="出品者アイコン"
        />
        {% else %}
        <img
          src="{{ url_for('static', filename='media/profile_icon.png') }}"
          alt="デフォルトアイコン"
        />
        {% endif %}
        <div class="text"> <h4>
            {% if uploader_id %}
            <a href="{{url_for('auth.view_profile', user_id=uploader_id)}}">
              {{ info.seller_name }}
            </a>
            {% else %}
            {{ info.seller_name }}
            {% endif %}
          </h4>
        </div> 
      </div>
      
      <div class="seller-rating-display">
          <h3>出品者評価</h3>
          
          {% set count = seller_rating_info.rating_count %}
          
          {% if count > 0 %}
              <p class="avg-rating">
                  {# 平均評価を float に変換し、四捨五入して星の数として使う #}
                  {% set avg_rating = seller_rating_info.average_rating | float %}
                  
                  {% for i in range(5) %}
                      {# loop.index は 1から5 #}
                      <span class="rating-star-icon 
                          {% if loop.index <= avg_rating | round %}filled{% else %}empty{% endif %}">★</span>
                  {% endfor %}
                  
                  <span class="rating-value">**{{ seller_rating_info.average_rating }}**</span>
              </p>
              <p class="rating-count">
                  ({{ count }} 件の評価)
              </p>
          {% else %}
              <p class="no-rating-msg">評価はありません。</p>
          {% endif %}
      </div>
      </div>
  </section>
  </div>

<div id="reportModal" class="modal hidden">
  <div class="modal-content">
    <h2>通報</h2>
    <form id="reportForm">
      <label
        ><input type="radio" name="reason" value="不適切" />
        公序良俗に反する内容を含む</label
      ><br />
      <label
        ><input type="radio" name="reason" value="違法商品" />
        違法・禁止商品の出品</label
      ><br />
      <label
        ><input type="radio" name="reason" value="著作権侵害" />
        著作権・商標権の侵害</label
      ><br />
      <label
        ><input type="radio" name="reason" value="虚偽" /> 商品説明が虚偽</label
      ><br />
      <label><input type="radio" name="reason" value="その他" /> その他</label
      ><br />
      <textarea
        name="detail"
        rows="4"
        placeholder="詳細内容を入力してください"
      ></textarea>
      <div class="modal-buttons">
        <button type="button" id="closeModal">キャンセル</button>
        <button type="submit" id="submitReport">報告</button>
      </div>
    </form>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<script src="{{url_for('static', filename='js/jquery-3.7.0.min.js')}}"></script>
<script
  src="{{ url_for('static', filename='js/product_detail.js') }}"
  defer
></script>
<script
  src="{{ url_for('static', filename='js/popup_report.js') }}"
  defer
></script>
{% endblock %}