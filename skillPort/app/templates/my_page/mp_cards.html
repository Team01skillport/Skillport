<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../../static/css/my_page_cards.css" /> 
</head>
<div class="cards-page-container">
    <div class="card-list-header">
        <h1 class="content-list-title">クレジットカード情報</h1> 
    </div>

    <div class="card-display-wrapper">

        {% if card_data %}
        
        <h2 class="register-form-title">
            登録済みのクレジットカード
        </h2>
        
        <div class="card-info-summary" id="cardSummary">
            <div class="card-detail-item">
                <span class="label">カード番号:</span> 
                <span class="value">**** **** **** {{ card_data.card_number[-4:] if card_data.card_number else '' }}</span>
            </div>
            
            <div class="card-detail-item">
                <span class="label">カード名義:</span> <span class="value">{{ card_data.holder_name }}</span>
            </div>
            
            <div class="card-detail-item">
                <span class="label">有効期限:</span> <span class="value">{{ card_data.expiry_month }}/{{ card_data.expiry_year }}</span>
            </div>
        </div>

        <div class="card-actions-summary">
            <button class="register-submit-btn" id="openEditForm">編集する</button> 
            <button class="delete-button-style" id="deleteCardBtn">削除する</button>
        </div>
        
        <div id="editFormSection" style="display: none; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <h3 style="margin-top: 0;">クレジットカード情報編集</h3>
            
            <form class="register-card-form" id="editCardForm">
                <div class="form-group">
                    <label class="form-label-small">カード番号</label>
                    <input type="text" id="editCardNumber" name="cardNumber" 
                           placeholder="例：1823 7712 8971 2870" required 
                           value="{{ card_data.card_number if card_data else '' }}" maxlength="19">
                </div>
                
                <div class="form-group">
                    <label class="form-label-small">名義人</label>
                    <input type="text" id="editCardHolderName" name="cardHolderName" 
                           placeholder="例：TAROU YAMADA" required
                           value="{{ card_data.holder_name if card_data else '' }}">
                </div>
                
                <div class="form-group">
                    <label class="form-label-small">有効期限 (月/年)</label>
                    <div class="expiry-group">
                        <input type="text" id="editExpiryMonth" name="expiryMonth" 
                               placeholder="MM" required pattern="\d{2}" maxlength="2"
                               value="{{ card_data.expiry_month if card_data else '' }}">
                        <span class="expiry-separator">/</span>
                        <input type="text" id="editExpiryYear" name="expiryYear" 
                               placeholder="YYYY" required pattern="\d{4}" maxlength="4"
                               value="{{ card_data.expiry_year if card_data else '' }}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label-small">セキュリティコード</label>
                    <div class="security-input-group">
                        <input type="text" id="editSecurityCode" name="securityCode" 
                               placeholder="例：564" required pattern="\d{3,4}" maxlength="4">
                    </div>
                </div>
                
                <div class="form-actions-modal">
                    <button type="submit" class="register-submit-btn">情報更新</button>
                    <button type="button" class="register-submit-btn" id="cancelEditForm" style="background-color: #aaa;">キャンセル</button>
                </div>
            </form>
        </div>

        {% else %}

        <h2 class="register-form-title">
            クレジットカード登録
        </h2>
        
        <form class="register-card-form" id="registerCardForm">
            <div class="form-group">
                <label class="form-label-small">カード番号</label>
                <input type="text" id="cardNumber" name="cardNumber" 
                       placeholder="例：1823 7712 8971 2870" required maxlength="19">
            </div>
            
            <div class="form-group">
                <label class="form-label-small">名義人</label>
                <input type="text" id="cardHolderName" name="cardHolderName" 
                       placeholder="例：TAROU YAMADA" required>
            </div>
            
            <div class="form-group">
                <label class="form-label-small">有効期限 (月/年)</label>
                <div class="expiry-group">
                    <input type="text" id="expiryMonth" name="expiryMonth" 
                           placeholder="MM" required pattern="\d{2}" maxlength="2">
                    <span class="expiry-separator">/</span>
                    <input type="text" id="expiryYear" name="expiryYear" 
                           placeholder="YYYY" required pattern="\d{4}" maxlength="4">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label-small">セキュリティコード</label>
                <div class="security-input-group">
                    <input type="text" id="securityCode" name="securityCode" 
                           placeholder="例：564" required pattern="\d{3,4}" maxlength="4">
                </div>
            </div>

            <div class="form-actions-modal">
                <button type="submit" class="register-submit-btn">登録する</button>
            </div>
        </form>

        {% endif %}
        
    </div>
    
    <script>
        // 卡号格式化函数 (自动添加空格)
        function formatCardNumber(inputElement) {
            let value = inputElement.value.replace(/\s/g, ''); // 移除所有空格
            let formattedValue = '';
            
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += ' ';
                }
                formattedValue += value[i];
            }
            
            // 限制最大长度 (16位数字 + 3个空格 = 19个字符)
            if (formattedValue.length > 19) {
                formattedValue = formattedValue.substring(0, 19);
            }
            
            inputElement.value = formattedValue;
        }

        $(document).ready(function() {
            
            // 绑定卡号格式化事件到注册和编辑表单
            $('#cardNumber, #editCardNumber').on('input', function() {
                formatCardNumber(this);
            });

            // ===================================
            // 提交逻辑 (注册和编辑共用)
            // ===================================
            const handleSave = function(e) {
                e.preventDefault();
                
                // 获取表单数据
                const form = $(this);
                // 确保移除卡号中的空格再序列化，以便后端处理
                const formData = form.serialize().replace(/cardNumber=([0-9%20]+)/g, function(match, p1) {
                    return 'cardNumber=' + p1.replace(/%20/g, '');
                });
                
                $.ajax({
                    url: '/my_page/save_card_info',
                    method: 'POST',
                    data: formData,
                    success: function(response) {
                        alert(response.message);
                        if (response.success) {
                            window.location.reload(); 
                        }
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON;
                        alert('保存失敗: ' + (error ? error.message : '予期せぬエラーが発生しました。'));
                    }
                });
            };

            $('#registerCardForm').on('submit', handleSave);
            $('#editCardForm').on('submit', handleSave);


            // ===================================
            // 界面切换和删除逻辑
            // ===================================
            const $editFormSection = $('#editFormSection');
            const $cardSummary = $('#cardSummary');
            const $cardActionsSummary = $('.card-actions-summary');

            // 绑定编辑按钮
            $('#openEditForm').on('click', function() {
                $cardSummary.hide();
                $cardActionsSummary.hide();
                $editFormSection.show();
            });

            // 绑定取消按钮
            $('#cancelEditForm').on('click', function() {
                $editFormSection.hide();
                $cardSummary.show();
                $cardActionsSummary.show();
            });
            
            // 绑定删除操作
            $('#deleteCardBtn').on('click', function() {
                if (confirm('登録済みのクレジットカード情報を削除してもよろしいですか？')) {
                    $.ajax({
                        url: '/my_page/delete_card_info',
                        method: 'POST',
                        success: function(response) {
                            alert(response.message);
                            if (response.success) {
                                window.location.reload();
                            }
                        },
                        error: function(xhr) {
                            const error = xhr.responseJSON;
                            alert('削除失敗: ' + (error ? error.message : '予期せぬエラーが発生しました。'));
                        }
                    });
                }
            });
        });
    </script>
</div>