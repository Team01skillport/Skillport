{% extends "base.html" %}

{# ================= ページのタイトル ================= #}
{% block title %}
取引詳細 - SkillPort
{% endblock %}

{# ================= ページ固有のCSS ================= #}
{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/transaction_detail.css') }}">
{% endblock %}


{# ================= メインコンテンツ ================= #}
{% block content %}
  <main class="transaction-main">
    <div class="transaction-container">

      <h1 class="transaction-h1">取引情報 (注文ID: {{ order.id }})</h1>

      <div class="transaction-content">

        {# 左側：交易及商品靜態資訊 #}
        <section class="transaction-info">
          
          <h2 class="info-title">取引情報</h2>
          
          {% if product %}
          <div class="info-product">
            {% if product.image_path %}
              <img src="{{ url_for('static', filename=product.image_path[1:]) }}" alt="{{ product.product_name }}" class="product-thumb" style="object-fit: cover; width: 60px; height: 60px; background-color: #eee;">
            {% else %}
              <div class="product-thumb">画像なし</div>
            {% endif %}
            
            <div class="product-details">
              <p class="product-name">{{ product.product_name }}</p>
            </div>
          </div>
          {% else %}
          <div class="info-product">
            <div class="product-thumb">?</div>
            <div class="product-details">
              <p class="product-name">商品情報が見つかりません</p>
            </div>
          </div>
          {% endif %}
          
          <div class="info-list">
            <div class="info-item">
              <span class="item-label">商品代金:</span>
              <span class="item-value">¥{{ order.total_amount | int }}</span>
            </div>
            <div class="info-item">
              <span class="item-label">送料:</span>
              <span class="item-value">出品者負担（送料込み）</span>
            </div>
            <div class="info-item">
              <span class="item-label">購入日時:</span>
              <span class="item-value">{{ order.transaction_startdate.strftime('%Y年%m月%d日 %H:%M') }}</span>
            </div>
            
            {% if product %}
            <div class="info-item">
              <span class="item-label">配送元の地域:</span>
              <span class="item-value">{{ product.shipping_area }}</span>
            </div>
            <div class="info-item">
              <span class="item-label">商品の状態:</span>
              <span class="item-value">{{ product.product_condition }}</span>
            </div>
            {% endif %}
            
            <div class="info-item">
              <span class="item-label">取引ステータス:</span>
              <span class="item-value">{{ order.transaction_status }}</span>
            </div>
          </div>

        </section>

        {# 右側：對話窗/訊息欄 - ⭐ 修改点 A: 评价显示和输入区隐藏 #}
        <section class="transaction-chat" data-order-id="{{ order.id }}">
          <h2 class="info-title">取引画面 (メッセージ)</h2>

          {# ⭐ 【新增】如果评价存在 (rated_info) 则显示评价内容 #}
          {% if rated_info %}
          <div class="rating-display-module">
              <h3>**取引完了:** 出品者への評価</h3>
              <p class="rating-stars-result">
                  {% for i in range(5) %}
                    <span class="star-icon {% if i < rated_info.rating %}filled{% endif %}">★</span>
                  {% endfor %}
                  ({{ rated_info.rating }} / 5)
              </p>
              {% if rated_info.comment %}
                <div class="rating-comment-bubble">{{ rated_info.comment }}</div>
              {% else %}
                <p class="no-comment-msg">コメントはありません。</p>
              {% endif %}
          </div>
          {% endif %}

          <div class="chat-messages" id="chatMessages">
              {% for msg in messages %}
                {% set user_role = 'buyer' if session.user_id|string == msg.order_message_user_id|string else 'seller' %}
                
                <div class="message-row {{ user_role }}">
                  <div class="user-avatar"></div> 
                  <div class="message-content">
                    <p class="message-user-name">{{ 'あなた' if user_role == 'buyer' else '出品者' }}</small></p>
                    <div class="message-bubble">
                      {{ msg.order_message_text }}
                    </div>
                  </div>
                </div>
              {% endfor %}
          </div>

          {# 訊息輸入欄: 只有在交易未完成 (未 '取引完了') 时显示，否则隐藏 #}
          {% if order.transaction_status != '取引完了' %}
          <div class="chat-input-area">
            <textarea id="messageInput" placeholder="メッセージを入力" rows="3"></textarea>
            <button class="send-button" id="sendMessageBtn" type="button">送信</button>
          </div>
          {% else %}
          <p style="text-align: center; color: #888; padding-top: 10px; border-top: 1px solid #eee;">取引は完了しました。新しいメッセージは送信できません。</p>
          {% endif %}
          
        </section>
      </div>

      <div class="flex-wrapper">
        {# 出品者資訊 #}
        <section class="seller-info">
          <h2 class="info-title">出品者情報</h2>
          
          {% if seller %}
          <div class="seller-details">
            {% if seller.profile_icon %}
              <img src="{{ url_for('static', filename=seller.profile_icon[1:]) }}" alt="出品者アイコン" class="seller-avatar">
            {% else %}
              <div class="seller-avatar"></div>
            {% endif %}
            
            <div class="seller-meta">
              <p class="seller-name">{{ seller.user_name }}</p>
              <p class="seller-stats">
                <small>{{ seller.user_tags }}</small>
              </p>
            </div>
            <div class="seller-rating">
              <span class="stars">★★★★★</span>
            </div>
          </div>
          {% endif %}
          
        </section>

        {# 取引完了アクション - ⭐ 修改点 B: 根据状态显示不同内容 #}
        <section class="finish-transaction 
            {% if order.transaction_status == '取引完了' %} rated-completed {% endif %}">

          <h2 class="info-title">取引を完了にする</h2>
          
          {% if order.transaction_status == '取引完了' %}

            {% if rated_info %}
              <p style="font-weight: bold; color: #5cb85c; font-size: 16px;">
                <span class="stars" style="font-size: 20px;">✓ </span>この取引は完了し、評価済みです。
              </p>
            {% else %}
              <p style="margin-bottom: 15px; font-weight: 500;">商品受取の確認が完了しました。</p>
              <a href="{{ url_for('market.rate_seller_page', order_id=order.id) }}">
                <button class="finish_trans_button" style="background-color:#f0ad4e; font-size: 16px;">出品者を評価する</button>
              </a>
            {% endif %}

          {% else %}
            <form action="{{ url_for('market.complete_transaction', order_id=order.id) }}" method="POST">
              <input type="checkbox" name="received_check" required>商品の中身を確認した
              <br>
              <button class="finish_trans_button" type="submit">取引完了</button>
            </form>
          {% endif %}
          
        </section>
      </div>
    </div>
  </main>
{% endblock %}

{# ================= ページ固有のJS ================= #}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/transaction_detail.js') }}" defer></script>
{% endblock %}